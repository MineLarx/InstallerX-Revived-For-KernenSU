name: Manual Stable Release

on:
  workflow_dispatch:
    inputs:
      version_tag:
        description: '输入版本标签 (例如 v2.2.3)'
        required: true
      changelog:
        description: '填写更新日志 (支持 Markdown)'
        required: true
        type: string

jobs:
  build_and_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up JDK 25
        uses: actions/setup-java@v5
        with:
          distribution: 'zulu'
          java-version: '25'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          # 手动发布版本无需写入构建缓存
          cache-read-only: true

      - name: Verify Keystore
        run: |
          if [ -z "${{ secrets.SIGNING_KEY_STORE_BASE64 }}" ]; then
            echo "ERROR: SIGNING_KEY_STORE_BASE64 secret is missing"
            exit 1
          fi

      - name: Setup Signing Keys
        env:
          SIGNING_KEY_STORE_BASE64: ${{ secrets.SIGNING_KEY_STORE_BASE64 }}
          SIGNING_STORE_PASSWORD: ${{ secrets.SIGNING_STORE_PASSWORD }}
          SIGNING_KEY_ALIAS: ${{ secrets.SIGNING_KEY_ALIAS }}
          SIGNING_KEY_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}
        run: |
          if [ -z "${SIGNING_STORE_PASSWORD:-}" ] || [ -z "${SIGNING_KEY_STORE_BASE64:-}" ] || [ -z "${SIGNING_KEY_PASSWORD:-}" ] || [ -z "${SIGNING_KEY_ALIAS:-}" ]; then
            exit 0
          fi
          mkdir -p keystore
          echo "${SIGNING_KEY_STORE_BASE64}" | base64 --decode > keystore/carlyu.jks
          echo "storeFile=keystore/carlyu.jks" > keystore.properties
          echo "keyAlias=${SIGNING_KEY_ALIAS}" >> keystore.properties
          echo "keyPassword=${SIGNING_KEY_PASSWORD}" >> keystore.properties
          echo "storePassword=${SIGNING_STORE_PASSWORD}" >> keystore.properties

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Build Stable Release APKs
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./gradlew assembleOnlineStableRelease assembleOfflineStableRelease -PAPP_ID="com.android.packageinstaller"

      - name: Find and Rename Universal APKs
        id: rename_apk
        run: |
          PROJECT_NAME="InstallerX-Revived"
          VERSION_TAG="${{ inputs.version_tag }}"
          for FLAVOR in online offline; do
            APK_DIR="app/build/outputs/apk/${FLAVOR}Stable/release/"
            ORIGINAL_APK=$(find "$APK_DIR" -maxdepth 1 -type f -name "*.apk" | head -n 1)

            if [ -z "$ORIGINAL_APK" ]; then
              echo "ERROR: APK not found in $APK_DIR!"
              ls -R app/build/outputs/apk
              exit 1
            fi

            NEW_APK_NAME="${PROJECT_NAME}-${FLAVOR}-${VERSION_TAG}.apk"
            NEW_APK_PATH="${APK_DIR}${NEW_APK_NAME}"

            echo "Renaming $ORIGINAL_APK -> $NEW_APK_PATH"
            mv "$ORIGINAL_APK" "$NEW_APK_PATH"
          done

      - name: Build KernelSU Module ZIPs
        id: build_module
        run: |
          MODULE_TEMPLATE="module"
          OUT_DIR="module_build"

          PROJECT_NAME="InstallerX-Revived"
          VERSION_TAG="${{ inputs.version_tag }}"

          ONLINE_APK="app/build/outputs/apk/onlineStable/release/${PROJECT_NAME}-online-${VERSION_TAG}.apk"
          OFFLINE_APK="app/build/outputs/apk/offlineStable/release/${PROJECT_NAME}-offline-${VERSION_TAG}.apk"

          ONLINE_MODULE_DIR="${OUT_DIR}/online_module"
          OFFLINE_MODULE_DIR="${OUT_DIR}/offline_module"

          mkdir -p "$ONLINE_MODULE_DIR"
          mkdir -p "$OFFLINE_MODULE_DIR"

          echo "Copying module template..."
          cp -r $MODULE_TEMPLATE/* "$ONLINE_MODULE_DIR/"
          cp -r $MODULE_TEMPLATE/* "$OFFLINE_MODULE_DIR/"
          
          echo "Sync module.prop version (Stable)..."

          ONLINE_PROP="$ONLINE_MODULE_DIR/module.prop"
          OFFLINE_PROP="$OFFLINE_MODULE_DIR/module.prop"

          if [ -f "$ONLINE_PROP" ]; then
            sed -i "s/^version=.*/version=${{ inputs.version_tag }}/" "$ONLINE_PROP"
            sed -i "s/^versionCode=.*/versionCode=$(date +%s)/" "$ONLINE_PROP"
          fi

          if [ -f "$OFFLINE_PROP" ]; then
            sed -i "s/^version=.*/version=${{ inputs.version_tag }}/" "$OFFLINE_PROP"
            sed -i "s/^versionCode=.*/versionCode=$(date +%s)/" "$OFFLINE_PROP"
          fi

          echo "Injecting APK..."

          ONLINE_TARGET="$ONLINE_MODULE_DIR/system/priv-app/PackageInstaller"
          OFFLINE_TARGET="$OFFLINE_MODULE_DIR/system/priv-app/PackageInstaller"

          mkdir -p "$ONLINE_TARGET"
          mkdir -p "$OFFLINE_TARGET"

          cp "$ONLINE_APK" "$ONLINE_TARGET/PackageInstaller.apk"
          cp "$OFFLINE_APK" "$OFFLINE_TARGET/PackageInstaller.apk"

          echo "Packing module zip..."

          ONLINE_ZIP="${PROJECT_NAME}-online-module-${VERSION_TAG}.zip"
          OFFLINE_ZIP="${PROJECT_NAME}-offline-module-${VERSION_TAG}.zip"

          cd "$ONLINE_MODULE_DIR"
          zip -r "../../$ONLINE_ZIP" .
          cd -

          cd "$OFFLINE_MODULE_DIR"
          zip -r "../../$OFFLINE_ZIP" .
          cd -

          echo "online_module_zip=$ONLINE_ZIP" >> $GITHUB_OUTPUT
          echo "offline_module_zip=$OFFLINE_ZIP" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "InstallerX Revived stable ${{ inputs.version_tag }}"
          tag_name: ${{ inputs.version_tag }}
          body: ${{ inputs.changelog }}
          prerelease: false
          files: |
            app/build/outputs/apk/onlineStable/release/InstallerX-Revived-online-${{ inputs.version_tag }}.apk
            app/build/outputs/apk/offlineStable/release/InstallerX-Revived-offline-${{ inputs.version_tag }}.apk
            ${{ steps.build_module.outputs.online_module_zip }}
            ${{ steps.build_module.outputs.offline_module_zip }}